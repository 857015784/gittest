source new_chinabrands_src2 {
    type                    = mysql #####数据源类型
    sql_host                = 192.168.6.71 ######mysql主机
    sql_user                = root ########mysql用户名
    sql_pass                = admin123 ########mysql密码
    sql_db                  = chinabrands_new_db ######mysql数据库名
	sql_port                = 3306 #######mysql端口
    mysql_connect_flags     = 32

    sql_query_pre         = SET NAMES utf8 ###mysql检索编码，特别要注意这点，很多人中文检索不到是数据库的编码是GBK或其他非UTF8
	sql_query_pre         = REPLACE INTO sphinx_counter SELECT 'chinabrands',MAX(sphinx_modify_time),UNIX_TIMESTAMP() FROM goods

    sql_query             = \
						SELECT *, SUM(a.month1sale_item) AS month1sale, SUM(a.week1sale_item) AS week1sale, SUM(a.week2sale_item) AS week2sale, SUM(a.month3sale_item) AS month3sale \
                            FROM (SELECT g.goods_id AS goods_id,g.goods_sn AS goods_sn,g.group_goods_id AS group_goods_id,g.cat_id AS cat_id,g.add_time AS add_time,\
							g.last_modify, replace(g.goods_title,',',' ') AS goods_title, wg.sale_time AS sale_time,wg.wid,\
							g.goods_thumb AS goods_thumb, g.goods_grid AS goods_grid,g.goods_img AS goods_img,wg.promote_price AS  promote_price,\
							wg.is_on_sale AS is_on_sale,wg.clearance_rate,g.is_delete AS is_delete,g.supply_state,wg.is_promote,wg.promote_discount,ge.recmd_level,\
							if((wg.promote_price > 0) AND (wg.promote_cancel_time = 0), 2000000000, wg.promote_cancel_time) as promote_cancel_time,\
                            wg.month1sale AS month1sale_item, wg.week1sale AS week1sale_item, wg.week2sale AS week2sale_item, wg.month3sale AS month3sale_item,\
							gd.goods_brief AS goods_brief,wg.shop_price AS shop_price,wg.vip_price AS vip_price,ge.goods_brand,ge.record_request,wg.is_clearance,wg.clearance_price,\
							if(((wg.goods_number = 0) OR (wg.goods_number = 88888) OR (wg.is_on_sale = 0) OR (g.is_delete > 0)),0,wg.goods_number) AS goods_number,ge.img_type AS img_type,\
                            IF(w.is_overseas=1, IF((wg.is_clearance = 1 OR g.supply_state = 3) AND wg.external_stock = 88888, 0, wg.external_stock), 88888) AS external_stock,\
							if((udg.download_number IS NULL),0,udg.download_number) AS download_number, wg.is_promotion_new, wg.retail_price,\
                            replace(ge.goods_words,'|',' ') AS goods_words,\
                            ge.goods_name, ge.brand_name, replace(c.search_words, ',', ' ') AS search_words,if((gb.brand_id IS NULL),0,gb.brand_id) AS brand_id, w.is_overseas, w.is_open, w.status AS warehouse_status\
							FROM goods AS g \
							LEFT JOIN goods_extend AS ge ON g.goods_id = ge.goods_id\
							LEFT JOIN warehouse_goods AS wg ON g.goods_id = wg.goods_id\
							LEFT JOIN goods_description AS gd ON g.goods_id = gd.goods_id \
                            LEFT JOIN category AS c ON g.cat_id = c.cat_id\
							LEFT JOIN user_download_goods AS udg ON (g.group_goods_id = udg.goods_id AND udg.user_id = 0)\
							LEFT JOIN goods_brand AS gb ON gb.goods_brand = ge.goods_brand \
							LEFT JOIN warehouse AS w ON wg.wid = w.wid \
							WHERE (c.is_show = 1 OR c.is_b2b_cat = 1) AND wg.is_on_sale =1 AND  g.is_delete=0 AND w.is_open=1 AND g.sphinx_modify_time <=(SELECT last_time FROM sphinx_counter WHERE index_name='chinabrands')\
							ORDER BY g.goods_id DESC,wg.wid ASC,wg.wid=4 ASC) AS a GROUP BY a.goods_id

    #########以下是用来过滤或条件查询的属性################
    sql_attr_timestamp   = add_time
    sql_attr_uint        = group_goods_id
    sql_attr_uint        = goods_number
    sql_attr_uint        = external_stock
    sql_attr_uint        = is_delete
    sql_attr_uint        = cat_id
    sql_field_string     = goods_title
    sql_attr_float       = shop_price
	sql_attr_float		 = vip_price
	sql_attr_float       = clearance_rate
    sql_attr_uint        = is_on_sale
    sql_attr_string      = goods_img
    sql_attr_string      = goods_thumb
	sql_attr_string      = goods_grid
    sql_attr_float       = promote_price
    sql_attr_float       = clearance_price
    sql_attr_float       = retail_price
    sql_attr_timestamp   = sale_time
	#sql_attr_timestamp   = last_modify
	sql_field_string     = goods_sn
    sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM goods
    sql_attr_uint        = img_type
	sql_field_string 	 = goods_brand
	sql_attr_uint 	 	 = is_clearance
	sql_attr_uint 	 	 = is_promote
	sql_attr_uint 	 	 = supply_state
	sql_attr_uint 	 	 = record_request
	sql_attr_uint 	 	 = month1sale
	sql_attr_uint 	 	 = week2sale
	sql_attr_uint 	 	 = week1sale
    sql_attr_uint        = month3sale
    sql_attr_uint        = recmd_level
    sql_attr_float       = promote_discount
    sql_attr_uint        = promote_cancel_time
    sql_attr_uint        = wid
    sql_attr_multi       = uint wid_all from query; SELECT wg.goods_id,wg.wid FROM warehouse_goods wg JOIN warehouse w ON wg.wid=w.wid JOIN goods g ON wg.goods_id=g.goods_id WHERE w.is_open=1 AND wg.is_on_sale=1 AND g.is_delete=0
    sql_attr_multi       = uint wid_all_out from query; SELECT wg.goods_id,wg.wid FROM warehouse_goods wg JOIN warehouse w ON wg.wid=w.wid JOIN goods g ON wg.goods_id=g.goods_id WHERE w.is_open=1 AND wg.is_on_sale=1 AND g.is_delete=0 AND IF(w.is_overseas = 1, wg.external_stock > 0 AND IF(wg.is_clearance = 1 OR g.supply_state = 3, wg.external_stock <> 88888, 1 = 1), 1 = 1)
	sql_attr_uint        = download_number
    sql_attr_uint        = is_promotion_new
	sql_attr_uint        = brand_id
    sql_attr_uint        = is_overseas
}
source new_chinabrands_delta2:new_chinabrands_src2{
    sql_query_pre         = SET NAMES utf8 ###mysql检索编码，特别要注意这点，很多人中文检索不到是数据库的编码是GBK或其他非UTF8
	sql_query_pre           = UPDATE sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='chinabrands'
    sql_query_post_index    = UPDATE sphinx_counter SET last_time=UNIX_TIMESTAMP()-18000 WHERE index_name='chinabrands'
    sql_query             = \
						SELECT *, SUM(a.month1sale_item) AS month1sale, SUM(a.week1sale_item) AS week1sale, SUM(a.week2sale_item) AS week2sale, SUM(a.month3sale_item) AS month3sale \
                            FROM (SELECT g.goods_id AS goods_id,g.goods_sn AS goods_sn,g.group_goods_id AS group_goods_id,g.cat_id AS cat_id,g.add_time AS add_time,\
							g.last_modify,replace(g.goods_title,',',' ') AS goods_title,wg.sale_time AS sale_time,wg.wid,\
							g.goods_thumb AS goods_thumb, g.goods_grid AS goods_grid,g.goods_img AS goods_img,wg.promote_price AS promote_price,\
							wg.is_on_sale AS is_on_sale,g.is_delete AS is_delete,g.supply_state,wg.is_promote,wg.promote_discount,ge.recmd_level,\
							if((wg.promote_price > 0) AND (wg.promote_cancel_time = 0), 2000000000, wg.promote_cancel_time) as promote_cancel_time,\
                            wg.month1sale AS month1sale_item, wg.week1sale AS week1sale_item, wg.week2sale AS week2sale_item, wg.month3sale AS month3sale_item,\
							gd.goods_brief AS goods_brief,wg.shop_price AS shop_price,wg.vip_price AS vip_price,ge.goods_brand,ge.record_request,wg.is_clearance,wg.clearance_price,\
							if(((wg.goods_number = 0) OR (wg.goods_number = 88888) OR (wg.is_on_sale = 0) OR (g.is_delete > 0)),0,wg.goods_number) AS goods_number,ge.img_type AS img_type,\
                            IF(w.is_overseas=1, IF((wg.is_clearance = 1 OR g.supply_state = 3) AND wg.external_stock = 88888, 0, wg.external_stock), 88888) AS external_stock,\
							if((udg.download_number IS NULL),0,udg.download_number) AS download_number, wg.is_promotion_new, wg.retail_price,\
                            replace(ge.goods_words,'|',' ') AS goods_words,\
                            ge.goods_name, ge.brand_name, replace(c.search_words, ',', ' ') AS search_words,if((gb.brand_id IS NULL),0,gb.brand_id) AS brand_id, w.is_overseas, w.is_open, w.status AS warehouse_status\
							FROM goods AS g \
							LEFT JOIN goods_extend AS ge ON g.goods_id = ge.goods_id\
							LEFT JOIN warehouse_goods AS wg ON g.goods_id = wg.goods_id\
							LEFT JOIN goods_description AS gd ON g.goods_id = gd.goods_id \
                            LEFT JOIN category AS c ON g.cat_id = c.cat_id\
							LEFT JOIN user_download_goods AS udg ON (g.group_goods_id = udg.goods_id AND udg.user_id = 0)\
							LEFT JOIN goods_brand AS gb ON gb.goods_brand = ge.goods_brand \
							LEFT JOIN warehouse AS w ON wg.wid = w.wid \
							WHERE g.sphinx_modify_time >(SELECT last_time FROM sphinx_counter WHERE index_name='chinabrands')\
							ORDER BY g.goods_id DESC,wg.wid ASC,wg.wid=4 ASC) AS a GROUP BY a.goods_id

	#########以下是用来过滤或条件查询的属性################
    sql_attr_timestamp   = add_time
    sql_attr_uint        = group_goods_id
    sql_attr_uint        = goods_number
    sql_attr_uint        = external_stock
    sql_attr_uint        = is_delete
    sql_attr_uint        = cat_id
    sql_field_string     = goods_title
    sql_attr_float       = shop_price
	sql_attr_float		 = vip_price
    sql_attr_uint        = is_on_sale
    sql_attr_string      = goods_img
    sql_attr_string      = goods_thumb
	sql_attr_string      = goods_grid
    sql_attr_float       = promote_price
    sql_attr_float       = clearance_price
    sql_attr_float       = retail_price
    sql_attr_timestamp   = sale_time
	#sql_attr_timestamp   = last_modify
	sql_field_string     = goods_sn
    sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM goods
    sql_attr_uint        = img_type
	sql_field_string 	 = goods_brand
	sql_attr_uint 	 	 = is_clearance
	sql_attr_uint 	 	 = is_promote
	sql_attr_uint 	 	 = supply_state
	sql_attr_uint 	 	 = record_request
	sql_attr_uint 	 	 = month1sale
	sql_attr_uint 	 	 = week2sale
	sql_attr_uint 	 	 = week1sale
    sql_attr_uint        = month3sale
    sql_attr_uint        = recmd_level
    sql_attr_float       = promote_discount
    sql_attr_uint        = promote_cancel_time
    sql_attr_uint        = wid
    sql_attr_multi       = uint wid_all from query; SELECT wg.goods_id,wg.wid FROM warehouse_goods wg JOIN warehouse w ON wg.wid=w.wid JOIN goods g ON wg.goods_id=g.goods_id WHERE w.is_open=1 AND wg.is_on_sale=1 AND g.is_delete=0
    sql_attr_multi       = uint wid_all_out from query; SELECT wg.goods_id,wg.wid FROM warehouse_goods wg JOIN warehouse w ON wg.wid=w.wid JOIN goods g ON wg.goods_id=g.goods_id WHERE w.is_open=1 AND wg.is_on_sale=1 AND g.is_delete=0 AND IF(w.is_overseas = 1, wg.external_stock > 0 AND IF(wg.is_clearance = 1 OR g.supply_state = 3, wg.external_stock <> 88888, 1 = 1), 1 = 1)
	sql_attr_uint        = download_number
    sql_attr_uint        = is_promotion_new
	sql_attr_uint        = brand_id
    sql_attr_uint        = is_overseas
}

index new_chinabrands2 {
    source               = new_chinabrands_src2
    path                 = /usr/local/sphinx/var/data/new_chinabrands2
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    infix_fields         = goods_sn,goods_brief,goods_title,keywords
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E ######### 指定utf-8编码表

}


index new_chinabrands_delta2:new_chinabrands2{
    source          = new_chinabrands_delta2
    path            = /usr/local/sphinx/var/data/new_chinabrands_delta2
    charset_type    = utf-8
}

#热搜词begin
source chinabrands_search_src
{
    type                    = mysql #####数据源类型
    sql_host                = 192.168.6.71 ######mysql主机
    sql_user                = root ########mysql用户名
    sql_pass                = admin123 ########mysql密码
    sql_db                  = chinabrands_new_db ######mysql数据库名
    sql_port                = 3306 #######mysql端口

    sql_query_pre           = SET NAMES utf8
    sql_query               = \
                              SELECT id,keyword,SUM(one_count) AS total_count, MAX(goods_num) AS goods_num \
                              FROM search_hot_keywords \
                              GROUP BY keyword

    sql_field_string    = keyword
    sql_attr_uint       = total_count
    sql_attr_uint       = goods_num
    sql_ranged_throttle = 0
}

index chinabrands_search_box
{
    source               = chinabrands_search_src
    path                 = /usr/local/sphinx/var/data/chinabrands_search_box
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E ######### 指定utf-8编码表
}
#热搜词end

# fba商品sku搜索statr
source new_chinabrands_fba_goods_search_src{

    type                    = mysql #####数据源类型
    sql_host                = 192.168.6.71 ######mysql主机
    sql_user                = root ########mysql用户名
    sql_pass                = admin123 ########mysql密码
    sql_db                  = chinabrands_new_db ######mysql数据库名
    sql_port                = 3306 #######mysql端口
    sql_query_pre         = SET NAMES utf8 ###mysql检索编码，特别要注意这点，很多人中文检索不到是数据库的编码是GBK或其他非UTF8
    sql_query             = SELECT a.goods_id,a.parent_sn,a.goods_sn,COUNT(c.spec_id) AS spec_count,IFNULL(e.group_spec_count,0) AS group_spec_count\
                        FROM\
                        goods AS a\
                        RIGHT JOIN\
                        warehouse_goods AS b\
                        ON\
                        a.goods_id = b.goods_id\
                        LEFT JOIN\
                        goods_packing_spec AS c\
                        ON\
                        a.goods_id = c.goods_id AND c.is_enable = 1 AND c.is_delete = 0\
                        LEFT JOIN\
                        category AS d\
                        ON\
                        a.cat_id = d.cat_id\
                        LEFT JOIN\
                        (\
                        SELECT a.parent_sn,COUNT(b.spec_id) AS group_spec_count\
                        FROM\
                        goods AS a\
                        LEFT JOIN\
                        goods_packing_spec AS b\
                        ON\
                        a.goods_id = b.goods_id\
                        WHERE\
                        b.is_enable = 1 AND b.is_group_available = 1 AND b.is_delete = 0\
                        GROUP BY parent_sn ORDER BY NULL\
                        ) e\
                        ON\
                        a.parent_sn = e.parent_sn\
                        WHERE\
                        b.wid = 1 AND b.is_on_sale = 1 AND b.shop_price > 0 AND a.is_delete = 0 AND d.is_show = 1\
                        GROUP BY a.goods_id ORDER BY NULL\

        #########以下是用来过滤或条件查询的属性################
    #sql_attr_uint        = goods_id
    sql_attr_uint        = spec_count
    sql_attr_uint        = group_spec_count
    sql_field_string     = goods_sn
    sql_field_string     = parent_sn

}
index new_chinabrands_fba_goods_search{
    source               = new_chinabrands_fba_goods_search_src
    path                 = /usr/local/sphinx/var/data/new_chinabrands_fba_goods_search
    charset_type         = utf-8
    docinfo              = extern
    enable_star          = 1
    infix_fields         = goods_sn,goods_brief,goods_title,keywords
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E ######### 指定utf-8编码表
}
# fba商品sku搜索end

indexer {
        mem_limit           = 512M
}


searchd {
    listen                  = 9303
    log                     = /usr/local/sphinx/var/log/new_chinabrands_searchd2.log
    query_log               = /usr/local/sphinx/var/log/new_chinabrands_query2.log
    pid_file                = /usr/local/sphinx/var/log/new_chinabrands_searchd2.pid
    read_timeout            = 5
    max_children            = 30
    max_matches             = 8000
    seamless_rotate         = 1
    preopen_indexes         = 0
    unlink_old              = 1
    binlog_path             =
    compat_sphinxql_magics  = 0
}
