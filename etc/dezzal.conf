#
# Minimal Sphinx configuration sample (clean, simple, functional)
#
##############dezzal
source dezzal
{
        type                                    = mysql
 
        sql_host                                = 10.40.6.46
        sql_user                                = root
        sql_pass                                = test1qaz2wsx 
        sql_db                                  = dezzal_db
        sql_sock                          =  /tmp/mysql.sock
        sql_port                                = 3306  # optional, default is 3306
sql_query_pre = SET NAMES utf8
        sql_query                               = \
select g.goods_id,g.goods_id as goods_id_attr,is_24h_ship,g.new_goods_sn,g.goods_sn, g.goods_title, g.goods_name, g.goods_brief, g.add_time, g.sort_order,g.brand_sort, g.group_goods_id, g.point_rate,g.seo_id, g.goods_weight, g.is_to_index,\
if(g.is_best=0,og.promote_start_date,1) AS promote_start_date, if(g.is_best=0,og.promote_end_date,9999999999) AS promote_end_date, ge.shelf_down_type,ge.overall_rate,ge.cxj , ge.clearance_discount, ge.clearance_date, \
g.is_free_shipping, g.is_hot,g.is_new, og.is_promote, g.week2sale,g.week1sale, g.week2sale as hitnum, IF (og.promote_start_date < UNIX_TIMESTAMP()AND og.promote_end_date > UNIX_TIMESTAMP()and og.promote_price <> '0.00',og.promote_price,og.shop_price) as shop_price,og.promote_price,g.is_login, g.cat_id, (if(og.goods_number=0,0,1)) as goods_number, \
                       ge.review_count AS reviews, CONCAT_WS(' ',g.goods_search_attr,CONCAT(',',GROUP_CONCAT(ga.attr_value separator ', ,'),',')) AS goods_attr, ge.goods_model, ge.brand_id,eb.name as goods_brand, \
 CONCAT_WS(' ',g.goods_title,GROUP_CONCAT(ga.attr_value separator ' ')) AS goods_title_color_size, \
		       REPLACE(g.goods_search_attr,',','') AS goods_search_attr_test, IF(EXISTS(SELECT id FROM eload_gift WHERE goods_sn=g.goods_sn AND web = 1 limit 1),1,0) AS has_gift_web,IF(EXISTS(SELECT id FROM eload_gift WHERE goods_sn=g.goods_sn AND wap = 1 limit 1),1,0) AS has_gift_wap,IF(EXISTS(SELECT id FROM eload_gift WHERE goods_sn=g.goods_sn AND wap = 1 limit 1),0,0) AS has_gift_app,\
                       CONCAT(IF(og.promote_start_date<UNIX_TIMESTAMP() AND og.promote_end_date>UNIX_TIMESTAMP(), 2, 1), EXISTS(SELECT goods_id FROM eload_goods_tuijian WHERE goods_id=g.goods_id AND (is_best=1 OR is_new=1 OR is_hot=1))) AS hot_order ,(ca.new_sort_order + UNIX_TIMESTAMP(FROM_UNIXTIME(g.add_time,'%Y-%m-%d'))*100) AS new_goods_weight\
                FROM eload_goods as g \
		LEFT JOIN eload_category AS ca ON g.cat_id=ca.cat_id \
				LEFT JOIN eload_os_goods as og ON g.goods_id = og.goods_id \
                LEFT JOIN eload_goods_extend as ge ON g.goods_id = ge.goods_id \
				LEFT JOIN eload_brand as eb ON ge.brand_id = eb.id \
                LEFT JOIN eload_goods_attr as ga ON g.goods_id = ga.goods_id \
                WHERE og.is_on_sale=1 AND g.is_delete=0 AND g.is_alone_sale = 1 AND g.goods_thumb != '' GROUP BY g.goods_id 
sql_attr_timestamp   = add_time
sql_attr_uint    = is_24h_ship
sql_attr_uint    = is_to_index

sql_attr_uint    = goods_id_attr
sql_attr_uint    = sort_order
sql_attr_uint    = brand_sort
sql_attr_uint    = shelf_down_type
sql_attr_float    = clearance_discount
sql_attr_uint    = clearance_date
sql_attr_uint    = goods_number
sql_attr_uint    = group_goods_id
sql_attr_float    = point_rate
sql_attr_uint    = is_free_shipping
sql_attr_uint    = is_hot
sql_attr_timestamp   = promote_start_date
sql_attr_timestamp   = promote_end_date
sql_attr_uint    = reviews
sql_attr_uint    = week2sale
sql_attr_uint 	 = week1sale
sql_attr_uint 	 = overall_rate
sql_attr_uint    = hitnum
sql_attr_float    =shop_price
sql_attr_float    =promote_price
sql_attr_uint    = is_login
sql_attr_uint    = has_gift_web
sql_attr_uint    = has_gift_wap
sql_attr_uint    = has_gift_app
sql_attr_uint    = is_new
sql_attr_float   = goods_weight
sql_attr_float   = cxj
sql_attr_bigint  = seo_id
sql_attr_uint    = cat_id
sql_attr_uint    =is_promote
sql_attr_uint    =hot_order

sql_attr_bigint = new_goods_weight
sql_field_string = goods_model
sql_attr_uint = brand_id

sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM (SELECT goods_id,cat_id FROM eload_goods UNION SELECT goods_id,cat_id FROM eload_goods_cat) AS t
sql_attr_multi		 = uint wid from query; SELECT og.goods_id,og.wid FROM eload_os_goods AS og LEFT JOIN eload_os_new_warehouse as ow ON og.wid=ow.wid LEFT JOIN eload_goods g ON og.goods_id=g.goods_id WHERE ow.is_open=1 AND og.is_on_sale=1 AND og.goods_number>0 AND g.is_delete=0
sql_attr_multi       = uint crc32 from query; SELECT goods_id,crc32 FROM eload_goods_desc_info where crc32 >0
}
 
index dezzal
{
    source               =  dezzal
    path                 = /usr/local/sphinx/var/data/dezzal
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    infix_fields         = goods_sn,new_goods_sn,goods_brief,goods_title,goods_name,goods_title_color_size,goods_search_attr_test,goods_brand
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E,U+43,U+26,U+28,U+29,U+2F,U+2D
}
##############dezzal end


#########dezzal_ABC


source dezzal_keywords {
    type                    = mysql
     sql_host                                = 10.40.6.46
        sql_user                                = root
        sql_pass                                = test1qaz2wsx 
        sql_db                                  = dezzal_db

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = REPLACE INTO eload_sphinx_counter SELECT 'dezzal_keywords',MAX(last_update_time),UNIX_TIMESTAMP() FROM eload_abc_index_keywords
    sql_query               = \
                            SELECT keyword_id,keyword_id AS keyword_id1,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete \
                            FROM eload_abc_index_keywords where is_show = 1
    sql_query_info          = \ SELECT * FROM eload_abc_index_keywords WHERE keyword_id=$id \
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('dezzal_keywords', 'dezzal_keywords')

    sql_attr_uint           = cat_id
    sql_attr_uint           = top_cat_id
    sql_attr_uint           = word_count
    sql_attr_uint           = is_delete
    #sql_attr_string         = keyword
    sql_field_string        = keyword
    sql_attr_uint           = goods_num
    sql_attr_uint           = keyword_id1

}
source dezzal_keywords_delta : dezzal_keywords {
    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = UPDATE eload_sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='dezzal_keywords'
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('dezzal_keywords', 'dezzal_keywords_delta')
    sql_query               = \
                            SELECT keyword_id,keyword_id AS keyword_id1,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete\
                            FROM eload_abc_index_keywords\
                            WHERE is_show=1 AND last_update_time>(SELECT last_time FROM eload_sphinx_counter WHERE index_name='dezzal_keywords')
}

index dezzal_keywords {
    source                  = dezzal_keywords
    path                    = /usr/local/sphinx/var/data/dezzal_keywords
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8

}

index dezzal_keywords_delta : dezzal_keywords {
    source                  = dezzal_keywords_delta
    path                    = /usr/local/sphinx/var/data/dezzal_keywords_delta
}




##############dezzal_recommend_keyword
source dezzal_recommend_keyword
{
        type                                    = mysql
		sql_host                                = 10.40.6.46
        sql_user                                = root
        sql_pass                                = test1qaz2wsx 
        sql_db                                  = dezzal_db
        #sql_sock                          =  /usr/local/ver04/mysql/var/mysql.sock
        sql_port                                = 3306
        
		sql_query                               = \
		select id,keyword,cat_id,lang,url,goods_number,`level`,uptime from `eload_recommend_keyword` where is_show = 1 GROUP BY keyword
		sql_attr_uint      = lang
		sql_attr_uint      = cat_id
		sql_attr_uint      = goods_number
		sql_attr_uint      = level
		sql_attr_timestamp = uptime
		sql_field_string   = keyword
		sql_field_string   = url

}

index dezzal_recommend_keyword {
    source                  = dezzal_recommend_keyword
		
	path                    = /usr/local/sphinx/var/data/dezzal_recommend_keyword
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8
	docinfo         		= extern
	enable_star         	= 1
	min_infix_len			= 1
	infix_fields			= keyword
	
}

##############dezzal_recommend_keyword end








indexer
{
	mem_limit		= 512M
}


searchd
{
	port			= 9311
	#listen			= 9306:mysql41
	log			= /usr/local/sphinx/var/log/dez_searchd.log
	query_log		= /usr/local/sphinx/var/log/dez_query.log
	read_timeout		= 5
	max_children		= 30
	pid_file		= /usr/local/sphinx/var/log/dez_searchd.pid
	max_matches		= 10000
	seamless_rotate		= 1
	preopen_indexes		= 1
	unlink_old		= 1
        compat_sphinxql_magics  = 0
	workers			= threads # for RT to work
	binlog_path		= #/usr/local/sphinx/var/data
}