
source nastydress
{
        type                                    = mysql
 
        sql_host                                = 192.168.6.71 
        sql_user                                = sphinx_user
        sql_pass                                = kwsYU53ukPEAuu
        sql_db                                  = nastydress_db_20141202
       #sql_sock                          =  /usr/local/ver01/mysql/var/mysql.sock
        sql_port                                = 3306  # optional, default is 3306
sql_query_pre = SET NAMES utf8
        sql_query               = \
select g.goods_id,is_24h_ship,ge.available_stock,g.goods_sn,g.new_goods_sn,(g.week2sale*g.shop_price) AS total_sales,g.url_title, g.goods_title, g.goods_name,ge.mobile_exclusive, ge.recommended_level, g.goods_brief, g.add_time,g.last_update, g.sort_order, g.group_goods_id, g.point_rate,  \
                       g.is_free_shipping, g.is_hot,g.is_new, g.is_promote, g.week1sale, c.is_show, g.week2sale, (select sum(hitnum) from eload_goods_hits where goods_id = g.goods_id) as click_count, g.shop_price, g.is_login, g.cat_id, g.attention_num, \
(if(goods_number=0 OR is_on_sale = 0 OR is_delete = 1,0,1)) as goods_number, gc.conversion_rate,gc.conversion_rate2,ge.goods_grade,ge.facebook_like_count,g.new_goods_sort_order, \
 ge.recommended_time,ge.shelf_down_type, ge.clearance_discount, ge.clearance_date, REPLACE(ge.goods_model,'|',' ') AS goods_model, \
 (if(g.add_time>UNIX_TIMESTAMP()-604800,if(g.img_type=2,1,(if(g.img_type=1,2,3))),4)) as self_img_type, \
(if(is_on_sale = 0 OR is_delete = 1,0,1)) as is_on_dispaly,if((g.week2sale-g.week1sale)=0,0,g.week1sale/((g.week2sale-g.week1sale))) as week_percent, \
 (if(g.is_new_promote = 0, 0, 1)) as is_new_promote, \
 ( (g.week2sale+1)*LN((IF (IFNULL(ge.available_stock, 0) <= 0, 0, ge.available_stock ))+1) ) AS cxj,(if(ge.shelf_down_type=100,1,if(ge.unsalable>0,1,0))) AS shelf_down_type_unsalable,g.goods_number AS goods_amount, \
 CONCAT_WS(' ',g.goods_title,GROUP_CONCAT(ga.attr_value separator ' '),replace(replace(g.goods_search_attr,',',''),'_',' ')) AS goods_title_color_size,GROUP_CONCAT(gac.attr_value separator ' ') AS goods_color,  \
                       REPLACE(g.goods_search_attr,',','') AS goods_search_attr_test, \
                       ge.review_count AS reviews, CONCAT_WS(' ',g.goods_search_attr,CONCAT(',',GROUP_CONCAT(ga.attr_value separator ', ,'),',')) AS goods_attr, \
                       CONCAT(IF(g.promote_start_date<UNIX_TIMESTAMP() AND g.promote_end_date>UNIX_TIMESTAMP(), 2, 1), EXISTS(SELECT goods_id FROM eload_goods_tuijian WHERE goods_id=g.goods_id AND (is_best=1 OR is_new=1 OR is_hot=1))) AS hot_order,g.recommendation,IF(g.promote_start_date<UNIX_TIMESTAMP() AND g.promote_end_date>UNIX_TIMESTAMP(), 2, 1) AS is_promote_ok, g.promote_start_date,g.promote_end_date,\
					   (if(ge.goods_brand='',0,1)) AS has_goods_brand,ge.is_distribution \
                FROM eload_goods as g \
                LEFT JOIN eload_category as c ON g.cat_id = c.cat_id \
                LEFT JOIN eload_goods_extend as ge ON g.goods_id = ge.goods_id \
                LEFT JOIN eload_goods_attr as ga ON g.goods_id = ga.goods_id \
				LEFT JOIN eload_goods_attr AS gac ON g.goods_id = gac.goods_id AND gac.`attr_id`=8 \
				LEFT JOIN eload_goods_conversion_rate AS gc ON g.goods_id=gc.goods_id \
                WHERE g.is_alone_sale = 1 AND g.goods_thumb != '' AND g.is_on_sale = 1 AND g.is_delete = 0  AND  g.goods_id NOT IN (SELECT goods_id FROM eload_goods_delete) GROUP BY g.goods_id

sql_attr_timestamp   = add_time
sql_attr_timestamp   = recommended_time
sql_attr_uint        = shelf_down_type
sql_attr_uint        = self_img_type
sql_attr_uint        = clearance_date
sql_attr_float    =clearance_discount
sql_attr_timestamp   = last_update
sql_attr_float  = conversion_rate
sql_attr_float  = conversion_rate2
sql_attr_float  = week_percent
sql_attr_uint    = is_24h_ship
sql_attr_uint   = sort_order
sql_attr_uint    =goods_grade
sql_attr_uint    = goods_number
sql_attr_uint    = available_stock
sql_attr_uint    = is_on_dispaly
sql_attr_uint    = group_goods_id
sql_attr_float    = point_rate
sql_attr_uint    = is_free_shipping
sql_attr_uint   = recommended_level
sql_attr_uint    = is_hot
sql_attr_uint    = is_show
sql_attr_uint   = promote_start_date
sql_attr_uint   = promote_end_date
sql_attr_uint    = reviews
sql_attr_uint    = week1sale
sql_attr_uint    = week2sale
sql_attr_float    = cxj
sql_attr_uint    = new_goods_sort_order
sql_attr_uint    = click_count
sql_attr_float    =shop_price
sql_attr_float    =total_sales
sql_attr_float    =mobile_exclusive
sql_attr_uint    =is_login
sql_attr_uint    =cat_id
sql_attr_uint = attention_num
sql_attr_uint    =is_new
sql_attr_uint    =is_promote
sql_attr_uint    =hot_order
sql_attr_uint    = is_promote_ok
sql_attr_uint    = is_new_promote
sql_attr_uint    =facebook_like_count
sql_attr_float   = recommendation
sql_field_string = goods_model
sql_field_string = url_title
sql_attr_uint    = shelf_down_type_unsalable
sql_attr_uint    = goods_amount
sql_attr_uint    = has_goods_brand
sql_attr_uint    = is_distribution
sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM (SELECT goods_id,cat_id FROM eload_goods UNION SELECT goods_id,cat_id FROM eload_goods_cat) AS t
sql_attr_multi       = uint search_attr from query; SELECT goods_id,crc32 FROM eload_goods_search_attr
}

index nastydress
{
    source               =  nastydress
    path                 = /usr/local/sphinx/var/data/nastydress
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    infix_fields         = goods_sn,new_goods_sn,goods_brief,goods_title,goods_name,goods_title_color_size,goods_attr,goods_color,goods_search_attr_test
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E,U+43,U+26,U+28,U+29,U+2F,U+2D
}
#nastydress_ja begin
#nastydress_ja begin



#########nastydress_ABC


source nastydress_keywords {
    type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = NvGHHsQvo3!90YS@
    sql_db                  = nastydress_db_20141202

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = REPLACE INTO eload_sphinx_counter SELECT 'nastydress_keywords',MAX(last_update_time),UNIX_TIMESTAMP() FROM eload_abc_index_keywords
    sql_query               = \
                            SELECT keyword_id,keyword_id AS keyword_id1,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete \
                            FROM eload_abc_index_keywords where is_show = 1
    sql_query_info          = \ SELECT * FROM eload_abc_index_keywords WHERE keyword_id=$id \
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('nastydress_keywords', 'nastydress_keywords')

    sql_attr_uint           = cat_id
    sql_attr_uint           = top_cat_id
    sql_attr_uint           = word_count
    sql_attr_uint           = is_delete
    #sql_attr_string         = keyword
    sql_field_string        = keyword
    sql_attr_uint           = goods_num
    sql_attr_uint           = keyword_id1

}

source nastydress_recommend_keywords {
    type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = NvGHHsQvo3!90YS@
    sql_db                  = nastydress_db_20141202

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = REPLACE INTO eload_sphinx_counter SELECT 'nastydress_recommend_keywords',MAX(uptime),UNIX_TIMESTAMP() FROM eload_recommend_keyword
    sql_query               = \
                            SELECT  id AS keyword_id,id AS keyword_id1,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,goods_number AS goods_num,0 AS is_delete \
                             FROM eload_recommend_keyword where is_show = 1
    sql_query_info          = \ SELECT * FROM eload_abc_index_keywords WHERE keyword_id=$id \
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('nastydress_recommend_keywords', 'nastydress_recommend_keywords')

    sql_attr_uint           = cat_id
    sql_attr_uint           = is_delete
    #sql_attr_string         = keyword
    sql_field_string        = keyword
    sql_attr_uint           = goods_num
    sql_attr_uint           = keyword_id1

}

source nastydress_keywords_delta : nastydress_keywords {
    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = UPDATE eload_sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='nastydress_keywords'
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('nastydress_keywords', 'nastydress_keywords_delta')
    sql_query               = \
                            SELECT keyword_id,keyword_id AS keyword_id1,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete\
                            FROM eload_abc_index_keywords\
                            WHERE is_show=1 AND last_update_time>(SELECT last_time FROM eload_sphinx_counter WHERE index_name='nastydress_keywords')
}

index nastydress_keywords {
    source                  = nastydress_keywords
    path                    = /usr/local/sphinx/var/data/nastydress_keywords
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8

}

index nastydress_recommend_keywords {
    source                  = nastydress_recommend_keywords
    path                    = /usr/local/sphinx/var/data/nastydress_recommend_keywords
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8

}

index nastydress_keywords_delta : nastydress_keywords {
    source                  = nastydress_keywords_delta
    path                    = /usr/local/sphinx/var/data/nastydress_keywords_delta
}


source nastydress_hot_keywords
{
        type                                    = mysql
        sql_host                                = 192.168.6.71
        sql_user                                = root
        sql_pass                                = NvGHHsQvo3!90YS@ 
        sql_db                                  = nastydress_db_20141202
        sql_sock                         		= /tmp/mysql.sock
        sql_port                                = 3306  
		sql_query_pre 							= SET NAMES utf8
        #测试机取得是30天以内的记录(线上3天内包括当天)
		sql_query                               = \
		SELECT ak.keyword_id,ak.keyword,SUM(k.count) AS three_count FROM  `eload_keywords` AS k INNER JOIN `eload_abc_index_keywords` AS ak  ON ak.`keyword`=k.`keyword` WHERE k.`searchengine`='NastyDress.com' AND k.date>=FROM_UNIXTIME(UNIX_TIMESTAMP()-24*3600*30,'%Y-%m-%d') GROUP BY k.`keyword` ORDER BY three_count DESC LIMIT 20000
		sql_attr_uint    = three_count
		sql_field_string   = keyword

}

index nastydress_hot_keywords {
    source                  = nastydress_hot_keywords
    path                    = /usr/local/sphinx/var/data/nastydress_hot_keywords
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8
	docinfo         		= extern
	enable_star         	= 1
	min_infix_len			= 1
	infix_fields			= keyword
	
}



indexer
{
    mem_limit               = 512M 
}


searchd
{
    port                    = 269
    log                     = /usr/local/sphinx/var/log/n_searchd.log
    query_log               = /usr/local/sphinx/var/log/n_query.log
    read_timeout            = 5
    max_children            = 30
    pid_file                = /usr/local/sphinx/var/log/n_searchd.pid
     binlog_path             =
      compat_sphinxql_magics  = 0
        max_matches             = 10000 
    seamless_rotate         = 1
    preopen_indexes         = 0
    unlink_old              = 1

}


