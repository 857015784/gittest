###new chinabrands indexer
source mnbase 
{
    type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = admin123
    sql_db                  = chinabrands_new_db
    sql_port                = 3306
    mysql_connect_flags     = 32    
    
    sql_query_pre         = SET NAMES utf8
    sql_query_pre         = REPLACE INTO sphinx_counter SELECT 'chinabrands',MAX(sphinx_modify_time),UNIX_TIMESTAMP() FROM goods

    sql_query             = \
						SELECT g.goods_id AS goods_id,g.goods_sn AS goods_sn,g.group_goods_id AS group_goods_id,g.cat_id AS cat_id,g.add_time AS add_time,\
								g.last_modify,ge.week2sale,ge.week1sale,ge.month1sale,ge.totalsale,\
								wg.is_on_sale AS is_on_sale,g.is_delete AS is_delete,replace(g.goods_title,',',' ') AS goods_title,\
								wg.sale_time AS sale_time,\
								wg.last_update AS last_update,g.goods_thumb AS goods_thumb,\
								g.goods_grid AS goods_grid,g.goods_img AS goods_img,wg.market_price AS market_price,wg.promote_price AS  promote_price,\
								wg.promote_start_date AS promote_start_date,wg.promote_end_date AS promote_end_date,\
								gd.goods_brief AS goods_brief,wg.shop_price AS shop_price,wg.vip_price AS vip_price,\
								if(((wg.goods_number = 0) OR (wg.goods_number = 88888) OR (wg.is_on_sale = 0) OR (g.is_delete > 0)),0,1) AS goods_number,ge.img_type AS img_type,\
								group_concat(ga.attr_value separator ',,') AS attr_value,group_concat(ga.attr_id separator ' ') AS attr_id \
								FROM goods AS g \
								LEFT JOIN goods_extend AS ge ON g.goods_id = ge.goods_id\
								LEFT JOIN warehouse_goods AS wg ON g.goods_id = wg.goods_id\
								LEFT JOIN goods_description AS gd ON g.goods_id = gd.goods_id \
								LEFT JOIN goods_attr AS ga ON g.goods_id = ga.goods_id \
								WHERE wg.is_on_sale =1 AND g.is_delete=0 AND g.sphinx_modify_time <=(SELECT last_time FROM sphinx_counter WHERE index_name='chinabrands')\
								GROUP BY g.goods_id
							
    #########以下是用来过滤或条件查询的属性################
    sql_attr_timestamp   = add_time
    sql_attr_uint        = group_goods_id
    sql_attr_uint        = goods_number
    sql_attr_uint        = is_delete
    sql_attr_uint        = cat_id
	sql_attr_uint        = week2sale
	sql_attr_uint        = week1sale
	sql_attr_uint        = month1sale
	sql_attr_uint        = totalsale	
	sql_field_string     = goods_sn
    sql_field_string     = goods_title
    sql_attr_float       = shop_price
    sql_attr_uint        = is_on_sale
    sql_attr_string      = goods_img
    sql_attr_string      = goods_thumb	
	sql_attr_string      = goods_grid
    sql_attr_uint        = promote_start_date
    sql_attr_uint        = promote_end_date
    sql_attr_float       = promote_price
    sql_attr_float       = market_price
    sql_attr_timestamp   = sale_time
	sql_attr_timestamp   = last_modify
    sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM goods
    sql_attr_uint        = img_type
}

source  mnbase_delta : mnbase
{
    sql_query_pre         = SET NAMES utf8 ###mysql检索编码，特别要注意这点，很多人中文检索不到是数据库的编码是GBK或其他非UTF8
    sql_query_pre         = UPDATE sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='chinabrands'
    sql_query_post_index  = UPDATE sphinx_counter SET last_time=(select MAX(sphinx_modify_time) from goods)  WHERE index_name='chinabrands'
    sql_query             = \
						SELECT g.goods_id AS goods_id,g.goods_sn AS goods_sn,g.group_goods_id AS group_goods_id,g.cat_id AS cat_id,g.add_time AS add_time,\ 								
								g.last_modify,ge.week2sale,ge.week1sale,ge.month1sale,ge.totalsale,\
								wg.is_on_sale AS is_on_sale,g.is_delete AS is_delete,replace(g.goods_title,',',' ') AS goods_title,\
								wg.sale_time AS sale_time,\
								wg.last_update AS last_update,g.goods_thumb AS goods_thumb,\
								g.goods_grid AS goods_grid,g.goods_img AS goods_img,wg.market_price AS market_price,wg.promote_price AS  promote_price,\
								wg.promote_start_date AS promote_start_date,wg.promote_end_date AS promote_end_date,\
								gd.goods_brief AS goods_brief,wg.shop_price AS shop_price,wg.vip_price AS vip_price,\
								if(((wg.goods_number = 0) OR (wg.goods_number = 88888) OR (wg.is_on_sale = 0) OR (g.is_delete > 0)),0,1) AS goods_number,ge.img_type AS img_type,\
								group_concat(ga.attr_value separator ',,') AS attr_value,group_concat(ga.attr_id separator ' ') AS attr_id \
								FROM goods AS g \
								LEFT JOIN goods_extend AS ge ON g.goods_id = ge.goods_id\
								LEFT JOIN warehouse_goods AS wg ON g.goods_id = wg.goods_id\
								LEFT JOIN goods_description AS gd ON g.goods_id = gd.goods_id \
								LEFT JOIN goods_attr AS ga ON g.goods_id = ga.goods_id \
								WHERE wg.is_on_sale =1 AND g.is_delete=0 AND g.sphinx_modify_time >(SELECT last_time FROM sphinx_counter WHERE index_name='chinabrands')\
								GROUP BY g.goods_id

							
	#########以下是用来过滤或条件查询的属性################
    sql_attr_timestamp   = add_time
    sql_attr_uint        = group_goods_id
    sql_attr_uint        = goods_number
    sql_attr_uint        = is_delete
    sql_attr_uint        = cat_id	
	sql_attr_uint        = week2sale
	sql_attr_uint        = week1sale
	sql_attr_uint        = month1sale
	sql_attr_uint        = totalsale	
	sql_field_string     = goods_sn
    sql_field_string     = goods_title
    sql_attr_float       = shop_price
    sql_attr_uint        = is_on_sale
    sql_attr_string      = goods_img
    sql_attr_string      = goods_thumb
	sql_attr_string      = goods_grid
    sql_attr_uint        = promote_start_date
    sql_attr_uint        = promote_end_date
    sql_attr_float       = promote_price
    sql_attr_float       = market_price
    sql_attr_timestamp   = sale_time
	sql_attr_timestamp   = last_modify
    sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM goods
    sql_attr_uint        = img_type
}

index mnbase
{
    source               = mnbase
    path                 = /usr/local/sphinx/var/data/mnbase
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    infix_fields         = goods_title,goods_sn,goods_brief,attr_value,shop_price
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E ######### 指定utf-8编码表
  }


index mnbase_delta:mnbase
{
    source          = mnbase_delta
    path            = /usr/local/sphinx/var/data/mnbase_delta
    charset_type    = utf-8
}

indexer
{
    mem_limit           = 512M
}

searchd
{
    listen                  = 9330
    log                     = /usr/local/sphinx/var/log/mnbasesearchd.log
    query_log               = /usr/local/sphinx/var/log/mnbasequery.log
    pid_file                = /usr/local/sphinx/var/log/mnbasesearchd.pid
    read_timeout            = 5
    max_children            = 60
    max_matches             = 10000
    seamless_rotate         = 1
    preopen_indexes         = 1
    unlink_old              = 1
    compat_sphinxql_magics  = 0
    binlog_path             = ###/usr/local/sphinx/var/data/new_chinabrands
}
