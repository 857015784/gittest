source wzhouhui
{
        type                    = mysql
 
         sql_host                =  192.168.6.71
        sql_user                = root
        sql_pass                = admin123

        sql_db                  = wzhouhui_db
        sql_port                = 3306  # optional, default is 3306
 
sql_query                               = \
select g.goods_id,g.is_delete,g.is_on_sale, g.goods_sn,ge.available_stock,ge.avg_rate as avg_rate,is_24h_ship,g.goods_title, g.goods_name, g.goods_brief, g.add_time, g.sort_order, g.group_goods_id, g.point_rate,g.promote_price,g.promote_start_date, g.promote_end_date, g.goods_thumb , g.goods_img,g.goods_grid ,g.url_title,g.goods_type,g.goods_weight,date_format(from_unixtime(`g`.`add_time`),'%Y%m%d') AS `add_date`,  ge.review_count AS reviews, g.brand, g.source, \
                       g.is_free_shipping, g.is_hot,g.is_new, g.is_promote, g.week2sale, g.click_count, g.shop_price, g.is_login, g.cat_id, (if(goods_number=0,0,1)) as goods_number,g.market_price ,\
if (is_new_sn,left(goods_sn,7),goods_sn) as group_goods_sn, \
                      count(DISTINCT rid) AS review_count,sum(rate_overall) as review_rate, g.goods_search_attr AS goods_attr, \
                       CONCAT(IF(g.promote_start_date<UNIX_TIMESTAMP() AND g.promote_end_date>UNIX_TIMESTAMP(), 2, 1), EXISTS(SELECT goods_id FROM eload_goods_tuijian WHERE goods_id=g.goods_id AND (is_best=1 OR is_new=1 OR is_hot=1))) AS hot_order, ge.shelf_down_type, ge.clearance_discount, ge.clearance_date, \
EXISTS(SELECT goods_id FROM eload_goods_extend WHERE goods_id=g.goods_id AND (is_24h_ship=1 OR goods_grade=1)) AS is_24_grade, ge.recommendation \
                FROM eload_goods as g \
                LEFT JOIN eload_review as r ON r.goods_id = g.goods_id \
                LEFT JOIN eload_goods_attr as ga ON g.goods_id = ga.goods_id \
                LEFT JOIN eload_goods_extend as ge ON g.goods_id = ge.goods_id \
                WHERE g.is_on_sale=1 AND g.is_delete=0 AND g.is_alone_sale = 1 AND g.goods_thumb != '' GROUP BY g.goods_id

	sql_field_string     = goods_title
	sql_field_string     = goods_name
	sql_field_string     = goods_brief
	sql_field_string     = goods_sn
	sql_attr_uint	     = available_stock
	sql_attr_string      = goods_thumb
	sql_attr_string      = goods_img
	sql_attr_string      = goods_grid
	sql_attr_string      = url_title
	sql_attr_uint        = add_date
	sql_attr_string      = group_goods_sn
	sql_attr_uint	     = is_delete
	sql_attr_uint        = is_on_sale	
	sql_attr_float       = promote_price

	sql_attr_uint        = promote_start_date
	sql_attr_uint        = promote_end_date

	sql_attr_uint        = goods_type
	sql_attr_uint	     = is_24h_ship	

	sql_attr_timestamp   = add_time
	sql_attr_uint        = sort_order 
	sql_attr_uint        = goods_number
	sql_attr_uint        = group_goods_id
	sql_attr_float       = point_rate
	sql_attr_uint        = is_free_shipping
	sql_attr_uint        = is_hot
	sql_attr_uint        = review_count
	sql_attr_uint        = week2sale
	sql_attr_uint        = click_count
	sql_attr_uint        = review_rate
	sql_attr_uint        = reviews
	sql_attr_float       = shop_price
	sql_attr_float       = market_price
	sql_attr_uint        = is_24_grade
	sql_attr_float       = goods_weight
	sql_attr_uint	     = shelf_down_type
	sql_attr_uint	     = clearance_discount
	sql_attr_uint	     = clearance_date

	sql_attr_uint        = is_login
	sql_attr_uint        = cat_id
	sql_attr_uint        = is_new
	sql_attr_uint        = is_promote
	sql_attr_uint        = hot_order
	sql_attr_uint        = avg_rate
	sql_attr_float	     = recommendation
	sql_field_string     = brand
	sql_attr_uint        = source
	sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM (SELECT goods_id,cat_id FROM eload_goods UNION SELECT goods_id,cat_id FROM eload_goods_cat) AS t
}
source wzhouhui_keywords {
    type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = admin123
    sql_db                  = wzhouhui_db

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = REPLACE INTO eload_sphinx_counter SELECT 'wzhouhui_keywords',MAX(last_update_time),UNIX_TIMESTAMP() FROM eload_abc_index_keywords 
    sql_query               = \
                            SELECT keyword_id,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete,is_exclude_words \
                            FROM eload_abc_index_keywords
    sql_query_info          = SELECT * FROM eload_abc_index_keywords WHERE keyword_id=$id
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('wzhouhui_keywords', 'wzhouhui_keywords')

    sql_attr_uint           = cat_id
    sql_attr_uint           = top_cat_id
    sql_attr_uint           = word_count
    sql_attr_uint           = is_delete
    sql_attr_string         = keyword
    sql_attr_uint           = goods_num
    sql_attr_uint           = is_exclude_words
}

source wzhouhui_keywords_delta : wzhouhui_keywords {
    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = UPDATE eload_sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='wzhouhui_keywords'
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('wzhouhui_keywords', 'wzhouhui_keywords_delta')
    sql_query               = \
                            SELECT keyword_id,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete,is_exclude_words \
                            FROM eload_abc_index_keywords\
                            WHERE last_update_time>(SELECT last_time FROM eload_sphinx_counter WHERE index_name='wzhouhui_keywords')
}
source wzhouhui_sphinx_keywords{
	type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = admin123
    sql_db                  = wzhouhui_db
    sql_query_pre           = SET NAMES utf8
	sql_query				=SELECT id,keyword as sphinx_keyword FROM eload_sphinx_keywords

	sql_field_string		=sphinx_keyword
	
}

index wzhouhui {
    source                  = wzhouhui
    path                    = /usr/local/sphinx/var/data/wzhouhui
    docinfo                 = extern
    #enable_star             = 1
    charset_type            = utf-8
    #infix_fields            = goods_sn,goods_brief,goods_title,keywords,color_size
    #min_infix_len           = 1
    charset_table		= 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E,U+43,U+26,U+28,U+29,U+2F,U+2D
}

index wzhouhui_keywords {
    source                  = wzhouhui_keywords
    path                    = /usr/local/sphinx/var/data/wzhouhui_keywords
    charset_table        = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8

}

index wzhouhui_keywords_delta : wzhouhui_keywords {
    source                  = wzhouhui_keywords_delta
    path                    = /usr/local/sphinx/var/data/wzhouhui_keywords_delta
}

index wzhouhui_sphinx_keywords{
    source                  = wzhouhui_sphinx_keywords
    path                    = /usr/local/sphinx/var/data/wzhouhui_sphinx_keywords
}

indexer {
        mem_limit           = 512M
}


searchd {
    listen                  = 9321
    log                     = /usr/local/sphinx/var/log/wzhouhui_searchd.log
    query_log               = /usr/local/sphinx/var/log/wzhouhui_query.log
    pid_file                = /usr/local/sphinx/var/log/wzhouhui_searchd.pid
    read_timeout            = 5
    max_children            = 30
    max_matches             = 10000
    seamless_rotate         = 1
    preopen_indexes         = 0
    unlink_old              = 1
    binlog_path             =
    compat_sphinxql_magics  = 0
}


