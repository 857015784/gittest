
# Minimal Sphinx configuration sample (clean, simple, functional)
#
source gearbest_test
{
        type                                    = mysql
        sql_host                                = 192.168.6.71
        sql_user                                = root
        sql_pass                                = admin123
        sql_db                                  = gearbest_test
       #sql_sock                          =  /usr/local/ver01/mysql/var/mysql.sock
        sql_port                                = 3306  # optional, default is 3306
sql_query_pre = SET NAMES utf8
        sql_query                               = \
select g.goods_id,ge.sub_title,url_title,is_24h_ship,g.goods_sn,g.promote_end_date,g.promote_start_date, g.goods_title, g.goods_name, ge.recommended_level, g.goods_brief, g.add_time,g.last_update, g.sort_order, g.group_goods_id, g.point_rate, g.attention_num,ge.presale_type, \
                      g.is_free_shipping,g.presale_date_from,g.presale_date_to, g.is_hot,g.is_new,g.is_cool,g.is_fun, g.is_promote, g.week2sale,ge.three_day_sale,g.click_count, g.shop_price, g.is_login, g.cat_id, \
(if(g.goods_number=0 OR  is_delete = 1,0,1)) as goods_number,(if(ge.stock_id_str != '',1,0)) as is_stock, gc.conversion_rate,gc.conversion_rate2,ge.goods_grade,ge.facebook_like_count, \
 ge.recommended_time,ge.shelf_down_type, ge.clearance_discount,ge.goods_brand, ge.clearance_date, date_format(from_unixtime(`g`.`add_time`),'%Y%m%d') AS `add_date`, \
(if(g.is_on_sale = 0 OR is_delete = 1,0,1)) as is_on_dispaly, \
 CONCAT_WS(' ',g.goods_title,GROUP_CONCAT(ga.attr_value separator ' '),replace(replace(g.goods_search_attr,',',''),'_',' ')) AS goods_title_color_size,replace(ge.goods_model,'|',' ') AS goods_model, \
                       ge.review_count AS reviews,ge.is_shot, CONCAT_WS(' ',g.goods_search_attr,CONCAT(',',GROUP_CONCAT(ga.attr_value separator ', ,'),',')) AS goods_attr,(if(g.is_cool = 1 OR g.is_fun = 1 OR g.cat_id in (11265,11269,11272,11274,11275,11277,11258,11260,11234,11241,11242),1,0)) as get_it_free, \
                       CONCAT(IF(g.promote_start_date<UNIX_TIMESTAMP() AND g.promote_end_date>UNIX_TIMESTAMP(), 2, 1), EXISTS(SELECT goods_id FROM eload_goods_tuijian WHERE goods_id=g.goods_id AND (is_best=1 OR is_new=1 OR is_hot=1))) AS hot_order \
                FROM eload_goods as g \
                LEFT JOIN eload_goods_extend as ge ON g.goods_id = ge.goods_id \
                LEFT JOIN eload_goods_attr as ga ON g.goods_id = ga.goods_id \
                LEFT JOIN eload_goods_conversion_rate AS gc ON g.goods_id=gc.goods_id \
		LEFT JOIN eload_os_goods og on g.goods_id = og.goods_id \
                WHERE g.is_alone_sale = 1 AND g.goods_thumb != '' AND (g.is_on_sale = 1 or (og.is_on_sale = 1 and og.goods_number > 0 )) GROUP BY g.goods_id

sql_attr_timestamp   = add_time
sql_attr_timestamp   = promote_end_date
sql_attr_timestamp   = promote_start_date
sql_attr_timestamp   = presale_date_from
sql_attr_timestamp   = presale_date_to
sql_attr_timestamp   = recommended_time
sql_attr_uint        = shelf_down_type
sql_attr_uint        = clearance_date
sql_attr_uint        = add_date
sql_attr_uint        = is_cool
sql_attr_uint        = is_fun
sql_attr_uint        = get_it_free
sql_attr_uint        = is_shot
sql_attr_float    =clearance_discount
sql_attr_timestamp   = last_update
sql_attr_float  = conversion_rate
sql_attr_float  = conversion_rate2
sql_attr_uint    = is_24h_ship
sql_attr_uint   = sort_order
sql_attr_uint    =goods_grade
sql_attr_uint    = goods_number
sql_attr_uint    = is_on_dispaly
sql_attr_uint    = group_goods_id
sql_attr_float    = point_rate
sql_attr_uint    = is_free_shipping
sql_attr_uint   = recommended_level
sql_attr_uint    = is_hot
sql_attr_uint	 = is_new_promote
sql_attr_uint    = reviews
sql_attr_uint    = week2sale
sql_attr_uint    = three_day_sale
sql_attr_uint    = click_count
sql_attr_float    =shop_price
sql_attr_uint    =is_login
sql_attr_uint    =cat_id
sql_attr_uint    =is_new
sql_attr_uint    =is_promote
sql_attr_uint    =hot_order
sql_attr_uint    = attention_num
sql_attr_uint    = is_stock
sql_attr_uint    = presale_type
sql_field_string  = sub_title
sql_attr_uint    =facebook_like_count
sql_field_string  = goods_title
sql_field_string  = goods_model
sql_field_string  = url_title
sql_attr_multi       = uint cat_id_all from query; SELECT goods_id,cat_id FROM (SELECT goods_id,cat_id FROM eload_goods UNION SELECT goods_id,cat_id FROM eload_goods_cat) AS t
sql_attr_multi       = uint m_stock_id from query; SELECT goods_id,stock_id FROM eload_goods_stock WHERE goods_stock>0
sql_attr_multi		 = uint wid from query; SELECT og.goods_id,og.wid FROM eload_os_goods og JOIN eload_os_warehouse ow ON og.wid=ow.wid JOIN eload_goods g ON og.goods_id=g.goods_id WHERE ow.is_open=1 AND og.is_on_sale=1 AND og.goods_number>0 AND g.is_delete=0 UNION SELECT goods_id,1 FROM eload_goods WHERE is_on_sale=1 AND goods_number>0 AND is_delete=0
}

index gearbest_test
{
    source               =  gearbest_test
    path                 = /usr/local/sphinx/var/data/gearbest_test
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    infix_fields         = goods_sn,goods_brief,goods_title,goods_name,goods_title_color_size,sub_title,presale_type,goods_model
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E,U+43,U+26,U+28,U+29,U+2F,U+2D,U+3E,U+3C
}
indexer {
        mem_limit           = 512M
}


source gearbest_order_popular {
	type                                    = mysql

        sql_host                                = 192.168.6.71
        sql_user                                = root
        sql_pass                                = admin123
        sql_db                                  = gearbest_db
       #sql_sock                          =  /usr/local/ver01/mysql/var/mysql.sock
        sql_port                                = 3306  # optional, default is 3306
	sql_query_pre = SET NAMES utf8
        sql_query                               = \
SELECT og.rec_id, og.order_id, og.goods_id, og.goods_sn, og.goods_number AS sale_number, og.addtime \
						 FROM eload_order_goods AS og \
						LEFT JOIN eload_goods AS g ON og.goods_id = g.goods_id \
						WHERE og.addtime >= UNIX_TIMESTAMP()-30*24*60*60 AND g.goods_number >0 AND g.is_on_sale = 1 AND g.is_delete = 0

    sql_attr_uint           = order_id
    sql_attr_uint           = goods_id
    sql_attr_uint           = sale_number
    sql_attr_uint           = addtime
}

index gearbest_order_popular
{
    source               =  gearbest_order_popular
    path                 = /usr/local/sphinx/var/data/gearbest_order_popular
    docinfo              = extern
    enable_star          = 1
    charset_type         = utf-8
    min_infix_len        = 1
    charset_table        = 0..9,A..Z->a..z,a..z,U+2C,U+2E,U+2B,U+5F,U+7B,U+7D,U+5E,U+43,U+26,U+28,U+29,U+2F,U+2D,U+3E,U+3C
}


source gearbest_keywords {
    type                    = mysql
    sql_host                = 192.168.6.71
    sql_user                = root
    sql_pass                = admin123
    sql_db                  = gearbest_db

    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = REPLACE INTO eload_sphinx_counter SELECT 'sammydress_keywords',MAX(last_update_time),UNIX_TIMESTAMP() FROM eload_abc_index_keywords
    sql_query               = \
                            SELECT keyword_id,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete \
                            FROM eload_abc_index_keywords
    sql_query_info          = SELECT * FROM eload_abc_index_keywords WHERE keyword_id=$id
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('sammydress_keywords', 'sammydress_keywords')

    sql_attr_uint           = cat_id
    sql_attr_uint           = top_cat_id
    sql_attr_uint           = word_count
    sql_attr_uint           = is_delete
    sql_attr_string         = keyword
    sql_attr_uint           = goods_num
}
source gearbest_keywords_delta : gearbest_keywords {
    sql_query_pre           = SET NAMES utf8
    sql_query_pre           = UPDATE eload_sphinx_counter SET begin_time=UNIX_TIMESTAMP() WHERE index_name='sammydress_keywords'
    #sql_query_post_index    = CALL sphinx_sql_query_post_index('sammydress_keywords', 'sammydress_keywords_delta')
    sql_query               = \
                            SELECT keyword_id,SUBSTRING(keyword,1,1) AS first_letter,keyword,cat_id,top_cat_id,goods_num,IF(word_count>5, 5, word_count) AS word_count,0 AS is_delete\
                            FROM eload_abc_index_keywords\
                            WHERE last_update_time>(SELECT last_time FROM eload_sphinx_counter WHERE index_name='gearbest_keywords')
}

index gearbest_keywords {
    source                  = gearbest_keywords
    path                    = /usr/local/sphinx/var/data/gearbest_keywords
	docinfo                 = extern
    enable_star             = 1
	min_infix_len           = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, .
    charset_type            = utf-8
	infix_fields            = keyword


}

index gearbest_keywords_delta : gearbest_keywords {
    source                  = gearbest_keywords_delta
    path                    = /usr/local/sphinx/var/data/gearbest_keywords_delta
}

searchd
{
	port			= 9318
	#listen			= 9306:mysql41
	log			= /usr/local/sphinx/var/log/searchd.log
	query_log		= /usr/local/sphinx/var/log/query.log
	read_timeout		= 5
	max_children		= 30
	pid_file		= /usr/local/sphinx/var/log/searchd.pid
	max_matches		= 10000
	seamless_rotate		= 1
	preopen_indexes		= 1
	unlink_old		= 1
        compat_sphinxql_magics  = 0
	workers			= threads # for RT to work
	binlog_path		= /usr/local/sphinx/var/data
	max_batch_queries	= 64
}
